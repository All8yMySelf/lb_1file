<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Leaderboard Manual Tester</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    form label { margin-right: 10px; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; }
  </style>
</head>
<body>
  <h1>Leaderboard Manual Tester</h1>
  <button id="randomBtn" type="button">Random Score</button>
  <form id="scoreForm">
    <label>Initials <input id="initials" maxlength="3" required></label>
    <label>Wave <input id="wave" type="number" required></label>
    <label>Time <input id="time" type="number" required></label>
    <label>Date <input id="date" type="date" required></label>
    <button type="submit">Submit Score</button>
  </form>
  <button id="refreshBtn">Refresh Leaderboard</button>
  <p id="leaderboardMessage"></p>
  <h2>Global Leaderboard</h2>
  <table id="leaderboard">
    <thead>
      <tr><th>Initials</th><th>Wave</th><th>Time</th><th>Date</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>

<script type="module" src="firebaseConfig.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

import { firebaseConfig } from "./firebaseConfig.js";
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function submitScore(initials, wave, timeLeft) {
  return push(ref(db, 'scores'), { initials: initials.toUpperCase(), wave, timeLeft, timestamp: Date.now() });
}

function loadTopScores() {
  const message = document.getElementById('leaderboardMessage');
  return get(ref(db, 'scores'))
    .then(snap => {
      const data = snap.val() || {};
      const scores = Object.values(data);
      scores.sort((a,b) => {
        if (b.wave !== a.wave) return b.wave - a.wave;
        return a.timeLeft - b.timeLeft;
      });
      if (message) message.textContent = '';
      return scores.slice(0,10);
    })
    .catch(err => {
      console.error(err);
      if (message) message.textContent = 'Unable to load leaderboard.';
      throw err;
    });
}

function renderLeaderboard(rows) {
  const tbody = document.querySelector('#leaderboard tbody');
  tbody.innerHTML = '';
  rows.forEach(row => {
    const tr = document.createElement('tr');
    const dateCell = new Date(row.timestamp).toISOString().split('T')[0];
    tr.innerHTML = `<td>${row.initials}</td><td>${row.wave}</td><td>${row.timeLeft}</td><td>${dateCell}</td>`;
    tbody.appendChild(tr);
  });
}

function fillRandomScore() {
  const randLetter = () => String.fromCharCode(65 + Math.floor(Math.random() * 26));
  document.getElementById('initials').value = randLetter() + randLetter() + randLetter();
  document.getElementById('wave').value = 8;
  document.getElementById('time').value = Math.floor(Math.random() * 60) + 1;
  document.getElementById('date').value = new Date().toISOString().split('T')[0];
}

document.getElementById('scoreForm').addEventListener('submit', e => {
  e.preventDefault();
  const initials = document.getElementById('initials').value;
  const wave = parseInt(document.getElementById('wave').value, 10);
  const time = parseInt(document.getElementById('time').value, 10);
  submitScore(initials, wave, time).then(() => loadTopScores().then(renderLeaderboard));
});

document.getElementById('randomBtn').addEventListener('click', fillRandomScore);

document.getElementById('refreshBtn').addEventListener('click', () => {
  loadTopScores().then(renderLeaderboard);
});

loadTopScores().then(renderLeaderboard);
</script>
